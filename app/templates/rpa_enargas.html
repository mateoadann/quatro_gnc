{% extends "base.html" %}

{% block content %}
<section class="hero compact">
  <div>
    <h1>RPA_Enargas</h1>
    <p>Ejecuta consultas automatizadas y gestiona los PDFs obtenidos.</p>
  </div>
</section>

<section class="grid two-col">
  <div class="card">
    <h2>Nueva consulta</h2>
    <form class="form-grid" method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="form-row">
        <label class="form-field">
          Patente
          <input
            type="text"
            name="patente"
            placeholder="AB123CD"
            pattern="^([A-Za-z]{3}[- ]?[0-9]{3}|[A-Za-z]{2}[- ]?[0-9]{3}[- ]?[A-Za-z]{2})$"
            title="Formato permitido: AAA123 o AA123AA"
            data-uppercase="true"
            data-strip="alnum"
            required
          />
        </label>
        <div class="form-actions">
          <button class="primary-btn" type="submit" id="rpa-submit" disabled>Crear proceso</button>
        </div>
      </div>
      <div class="form-row form-row--split">
        <label class="form-field">
          Taller
          <div class="select-field">
            <select name="taller_id" id="taller-select" required>
              <option value="">Selecciona un taller</option>
              {% for taller in talleres %}
              <option value="{{ taller.id }}">{{ taller.nombre }}</option>
              {% endfor %}
            </select>
          </div>
        </label>
        <div class="form-actions">
          <button class="ghost-btn" type="button" id="taller-create-btn">Crear taller</button>
        </div>
      </div>
      <input type="hidden" name="taller_name" id="taller-name" />
      <p class="muted">Solo se aceptan patentes AAA123 o AA123AA.</p>
    </form>
    <div
      class="session-status"
      data-session-status-url="{{ url_for('main.rpa_enargas_session_status') }}"
    >
      <div class="session-status__content" id="rpa-session-status" aria-live="polite"></div>
    </div>
    <div class="modal" id="taller-modal" aria-hidden="true">
      <div class="modal-overlay" data-modal-close></div>
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="taller-modal-title">
        <h3 id="taller-modal-title">Nuevo taller</h3>
        <p class="muted">Ingresa el nombre del taller que queres agregar.</p>
        <label class="form-field">
          Nombre del taller
          <input type="text" id="taller-modal-name" placeholder="Ej: Taller Central" />
        </label>
        <div class="modal-error is-hidden" id="taller-modal-error">El nombre es obligatorio.</div>
        <div class="modal-actions">
          <button class="ghost-btn" type="button" data-modal-close>Cancelar</button>
          <button class="primary-btn" type="button" id="taller-modal-save">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Guia rapida</h2>
    <div class="helper-block">
      <h3>Estados</h3>
      <ul>
        <li><strong>En proceso:</strong> el RPA esta ejecutando.</li>
        <li><strong>Completado:</strong> termino la consulta.</li>
        <li><strong>Error:</strong> fallo tecnico, reintentar.</li>
      </ul>
      <h3>Resultados</h3>
      <ul>
        <li><strong>Renovación de Oblea:</strong> apto para renovar.</li>
        <li><strong>Prueba Hidraulica:</strong> requiere prueba previa.</li>
        <li><strong>Patente NO registrada:</strong> no figura en ENARGAS.</li>
        <li><strong>Sesión Activa:</strong> esperar y reintentar.</li>
      </ul>
    </div>
  </div>
</section>

<section class="grid stack">
  <div
    class="card"
    data-auto-refresh="{{ 'true' if has_pending else 'false' }}"
    data-refresh-interval="5000"
    data-refresh-url="{{ url_for('main.rpa_enargas_table', page=page) }}"
  >
    <h2>Consultas recientes</h2>
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Patente</th>
          <th>Taller</th>
          <th>Estado</th>
          <th>Resultado</th>
          <th>Detalle</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="rpa-table-body">
        {% include "partials/rpa_enargas_rows.html" %}
      </tbody>
    </table>
    <div id="rpa-pagination" class="table-footer">
      {% include "partials/rpa_pagination.html" %}
    </div>
  </div>
</section>
{% endblock %}
